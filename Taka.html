<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Taka Hisab</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      /* ‚úÖ LIGHT + COLORFUL THEME */
      --bg:#f7f9ff;
      --bg2:#ffffff;

      --surface:#ffffff;
      --surface2:#f3f6ff;

      --line: rgba(15,23,42,.10);
      --line2: rgba(15,23,42,.14);

      --text: #0f172a;
      --muted: rgba(15,23,42,.62);

      --brand:#4f46e5;     /* indigo */
      --brand2:#22c55e;    /* green */
      --pink:#ec4899;
      --violet:#8b5cf6;
      --orange:#f59e0b;
      --cyan:#06b6d4;
      --sky:#38bdf8;
      --bad:#ef4444;

      --r14:14px;
      --r18:18px;

      --topbar-h: 74px;
      --sb-w: 288px;

      --shadow: 0 18px 55px rgba(15,23,42,.12);
      --shadow2: 0 10px 26px rgba(15,23,42,.10);

      --glass: rgba(255,255,255,.72);
      --glass2: rgba(255,255,255,.92);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family:'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1100px 520px at 12% 0%, rgba(79,70,229,.20), transparent 58%),
        radial-gradient(900px 520px at 95% 18%, rgba(56,189,248,.20), transparent 55%),
        radial-gradient(950px 620px at 60% 100%, rgba(34,197,94,.16), transparent 55%),
        radial-gradient(900px 520px at 10% 92%, rgba(236,72,153,.12), transparent 60%),
        linear-gradient(180deg, #fbfcff, #eef2ff 55%, #f9fbff);
      overflow-x:hidden;
    }

    /* subtle noise */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.045;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      mix-blend-mode: multiply;
    }

    /* ===== Navbar ===== */
    .navbar{
      height: var(--topbar-h);
      position: fixed;
      inset: 0 0 auto 0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0 14px;
      z-index: 80;
      backdrop-filter: blur(16px);
      background:
        linear-gradient(180deg, rgba(255,255,255,.86), rgba(255,255,255,.70));
      border-bottom: 1px solid var(--line);
    }

    .nav-inner{
      width: min(1040px, 100%);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .menu-icon{
      width: 46px;
      height: 46px;
      border-radius: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: var(--shadow2);
      transition: transform .18s ease, background .18s ease, border-color .18s ease;
      font-size: 20px;
      color: #0f172a;
      position: relative;
      overflow:hidden;
    }
    .menu-icon::after{
      content:"";
      position:absolute;
      inset:-40px -40px auto auto;
      width:120px;height:120px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(79,70,229,.25), rgba(56,189,248,.18), rgba(34,197,94,.18));
      transform: rotate(18deg);
      opacity:.9;
    }
    .menu-icon > *{ position:relative; z-index:1; }
    .menu-icon:hover{
      background: #ffffff;
      border-color: rgba(79,70,229,.25);
      transform: translateY(-1px);
    }
    .menu-icon:active{ transform: scale(.98); }

    .nav-title{
      display:flex;
      flex-direction:column;
      align-items:center;
      line-height:1.1;
      gap: 2px;
    }
    .nav-title h1{
      margin:0;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .3px;
      background: linear-gradient(90deg, #4f46e5, #06b6d4, #22c55e);
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
    }
    .nav-title small{
      color: var(--muted);
      font-weight: 800;
      font-size: 11px;
    }

    .nav-badge{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: var(--shadow2);
      font-size: 12px;
      color: rgba(15,23,42,.72);
      white-space: nowrap;
      position: relative;
      overflow:hidden;
    }
    .nav-badge::before{
      content:"";
      position:absolute;
      inset:auto -30px -30px auto;
      width:120px;height:120px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(236,72,153,.18), rgba(245,158,11,.16), rgba(79,70,229,.14));
      opacity:.9;
    }
    .nav-badge > *{ position:relative; z-index:1; }

    .dot{
      width: 8px; height: 8px; border-radius: 999px;
      background: var(--brand2);
      box-shadow: 0 0 0 6px rgba(34,197,94,.14);
    }

    /* ===== Sidebar (colorful) ===== */
    .sidebar{
      position: fixed;
      top: var(--topbar-h);
      left: calc(-1 * var(--sb-w));
      width: var(--sb-w);
      height: calc(100% - var(--topbar-h));
      padding: 14px 12px;
      z-index: 70;
      transition: .28s ease;
      background:
        linear-gradient(180deg, rgba(255,255,255,.92), rgba(245,247,255,.92));
      border-right: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 18px 60px rgba(15,23,42,.14);
      backdrop-filter: blur(14px);
    }
    .sidebar.open{ left: 0; }

    .sb-card{
      border-radius: 18px;
      padding: 14px;
      background: linear-gradient(135deg, rgba(79,70,229,.14), rgba(56,189,248,.12), rgba(34,197,94,.10));
      border: 1px solid rgba(79,70,229,.16);
      box-shadow: var(--shadow2);
      margin-bottom: 12px;
      position: relative;
      overflow: hidden;
    }
    .sb-card::after{
      content:"";
      position:absolute;
      right:-60px; top:-60px;
      width:160px; height:160px;
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.85), rgba(255,255,255,0));
    }
    .sb-card h3{
      margin:0;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .2px;
      position:relative;
      z-index:1;
    }
    .sb-card p{
      margin:6px 0 0 0;
      color: rgba(15,23,42,.70);
      font-size: 12px;
      line-height:1.4;
      position:relative;
      z-index:1;
      font-weight: 700;
    }

    .sidebar a{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 12px 12px;
      margin: 8px 2px;
      border-radius: 16px;
      color: #0f172a;
      text-decoration:none;
      font-size: 14px;
      font-weight: 900;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 10px 18px rgba(15,23,42,.08);
      transition: transform .18s ease, background .18s ease, border-color .18s ease;
      position: relative;
      overflow:hidden;
    }
    .sidebar a::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width: 4px;
      background: linear-gradient(180deg, #4f46e5, #06b6d4, #22c55e);
      opacity:.85;
    }
    .sidebar a::after{
      content:"";
      position:absolute;
      inset:auto -70px -70px auto;
      width:160px;height:160px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(236,72,153,.14), rgba(245,158,11,.12), rgba(79,70,229,.10));
      opacity:.9;
      transform: rotate(-10deg);
    }
    .sidebar a > *{ position:relative; z-index:1; }
    .sidebar a:hover{
      background: #ffffff;
      border-color: rgba(79,70,229,.22);
      transform: translateY(-1px);
    }

    /* ===== Main ===== */
    .main-content{
      margin-top: calc(var(--topbar-h) + 10px);
      padding: 18px 14px 6px 14px;
      width: min(1040px, 100%);
      margin-left:auto;
      margin-right:auto;
    }

    /* Cards */
    .cards-container{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .card{
      border-radius: 20px;
      padding: 14px 14px;
      border: 1px solid rgba(15,23,42,.16);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow2);
      position: relative;
      overflow:hidden;
      min-height: 92px;
      transition: transform .18s ease, border-color .18s ease, background .18s ease;
    }
    .card:hover{
      transform: translateY(-2px);
      border-color: rgba(15,23,42,.26);
      background: #ffffff;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-70px -70px auto auto;
      width: 150px; height: 150px;
      border-radius: 999px;
      background: rgba(255,255,255,.70);
      transform: rotate(18deg);
    }
    .card::after{
      content:"";
      position:absolute;
      inset:auto -90px -90px auto;
      width: 190px; height: 190px;
      border-radius: 999px;
      background: rgba(15,23,42,.06);
      transform: rotate(-8deg);
    }

    .card h3{
      margin:0;
      font-size: 12px;
      letter-spacing: .25px;
      font-weight: 900;
      color: rgba(15,23,42,.84);
      position:relative;
      z-index:1;
    }
    .card p{
      margin: 6px 0 0 0;
      font-size: 20px;
      font-weight: 900;
      letter-spacing: .3px;
      position:relative;
      z-index:1;
      color:#0b1220;
    }

    .card1{ background: linear-gradient(135deg, rgba(79,70,229,.22), rgba(255,255,255,.92)); }
    .card2{ background: linear-gradient(135deg, rgba(56,189,248,.22), rgba(255,255,255,.92)); }
    .card3{ background: linear-gradient(135deg, rgba(34,197,94,.20), rgba(255,255,255,.92)); }
    .card4{ background: linear-gradient(135deg, rgba(245,158,11,.22), rgba(255,255,255,.92)); }
    .card5{ background: linear-gradient(135deg, rgba(236,72,153,.20), rgba(255,255,255,.92)); }
    .card6{ background: linear-gradient(135deg, rgba(249,115,22,.20), rgba(255,255,255,.92)); }
    .card7{ background: linear-gradient(135deg, rgba(139,92,246,.18), rgba(255,255,255,.92)); }
    .card8{ background: linear-gradient(135deg, rgba(6,182,212,.18), rgba(255,255,255,.92)); }

    /* Buttons bar */
    .cash-buttons{
      width: min(1040px, 100%);
      margin: 12px auto 0 auto;
      padding: 0 14px;
      display:flex;
      gap: 10px;
    }
    .cash-buttons button{
      flex: 1;
      border: none;
      border-radius: 16px;
      padding: 12px 10px;
      cursor:pointer;
      color: #fff;
      font-weight: 900;
      font-size: 11px;
      letter-spacing:.25px;
      box-shadow: var(--shadow2);
      transition: transform .18s ease, filter .18s ease;
      border: 1px solid rgba(255,255,255,.70);
      position: relative;
      overflow:hidden;
    }
    .cash-buttons button::after{
      content:"";
      position:absolute;
      inset:-60px -60px auto auto;
      width:140px;height:140px;
      border-radius:999px;
      background: rgba(255,255,255,.26);
      transform: rotate(20deg);
    }
    .cash-buttons button > *{ position:relative; z-index:1; }
    .cash-buttons button:hover{ filter: brightness(1.05); transform: translateY(-1px); }
    .cash-buttons button:active{ transform: scale(.99); }

    .cash-in-btn{ background: linear-gradient(135deg, #16a34a, #22c55e); }
    .cash-out-btn{ background: linear-gradient(135deg, #dc2626, #ef4444); }
    .c-convert{ background: linear-gradient(135deg, #c2410c, #f59e0b); }
    .t-b2b{ background: linear-gradient(135deg, #0ea5e9, #4f46e5); }

    /* Popup */
    .popup-form{
      position: fixed;
      inset: 0;
      background-color: rgba(2, 6, 23, 0.38);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 16px;
      backdrop-filter: blur(8px);
    }
    .form-content{
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.94));
      color: #0f172a;
      padding: 18px;
      border-radius: 20px;
      box-shadow: 0 18px 65px rgba(15,23,42,.22);
      width: 100%;
      max-width: 440px;
      border: 1px solid rgba(15,23,42,.10);
      position:relative;
      overflow:hidden;
    }
    .form-content::before{
      content:"";
      position:absolute;
      inset:-80px -80px auto auto;
      width:180px;height:180px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(79,70,229,.14), rgba(56,189,248,.12), rgba(236,72,153,.10));
      transform: rotate(18deg);
      opacity:.9;
    }
    .form-content > *{ position:relative; z-index:1; }

    .takad-text{
      font-size: 18px;
      margin: 0 0 14px 0;
      text-align:center;
      font-weight: 900;
      letter-spacing:.2px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(15,23,42,.10);
      background: linear-gradient(90deg, #4f46e5, #06b6d4, #22c55e);
      -webkit-background-clip:text;
      background-clip:text;
      color: transparent;
    }

    .row-line-time, .row-line-type{
      display:flex;
      gap: 10px;
      margin-bottom: 12px;
    }

    .time-box, .date-box{
      flex: 1;
      display:flex;
      align-items:center;
      justify-content: space-between;
      border: 1px solid rgba(15,23,42,.12);
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(79,70,229,.03);
      cursor:pointer;
      position: relative;
      transition: border-color .18s ease, background .18s ease;
    }
    .time-box:hover, .date-box:hover{
      background: rgba(56,189,248,.06);
      border-color: rgba(79,70,229,.25);
    }
    .time-box span, .date-box span{
      font-size: 13px;
      font-weight: 900;
      color: #0f172a;
    }
    .hidden-picker{
      position:absolute;
      opacity:0;
      width:100%;
      height:100%;
      left:0;
      top:0;
      cursor:pointer;
    }
    .icon{ width: 18px; height:18px; opacity:.75; }

    .account-type-a, .account-type-b{
      flex:1;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(79,70,229,.03);
      font-weight: 900;
      transition: border-color .18s ease, background .18s ease;
      outline: none;
    }
    .account-type-a:focus, .account-type-b:focus{
      border-color: rgba(79,70,229,.45);
      background: rgba(79,70,229,.06);
    }

    .amount-section{
      display:flex;
      flex-direction:column;
      gap: 8px;
      align-items:center;
      margin-bottom: 12px;
    }
    .amount-section label{
      font-weight: 900;
      color: rgba(15,23,42,.70);
      font-size: 12px;
    }

    .taka-input, .charge-input{ width:100%; max-width: 280px; }
    .taka-input input, .charge-input input{
      width:100%;
      padding: 12px;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 900;
      text-align:center;
      outline: none;
      border: 2px solid rgba(79,70,229,.28);
      background:#fff;
      transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease;
    }
    .taka-input input:focus, .charge-input input:focus{
      border-color: rgba(79,70,229,.62);
      box-shadow: 0 10px 22px rgba(79,70,229,.14);
      transform: translateY(-1px);
    }
    .charge-input input{ border-color: rgba(239,68,68,.28); }
    .charge-input input:focus{
      border-color: rgba(239,68,68,.62);
      box-shadow: 0 10px 22px rgba(239,68,68,.12);
    }

    #inDescription, #outDescription, #cDescription, #b2bDescription{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(79,70,229,.03);
      margin-bottom: 12px;
      box-sizing:border-box;
      font-weight: 800;
      outline:none;
      transition: border-color .18s ease, background .18s ease;
    }
    #inDescription:focus, #outDescription:focus, #cDescription:focus, #b2bDescription:focus{
      border-color: rgba(79,70,229,.45);
      background: rgba(56,189,248,.06);
    }

    .button-row{
      display:flex;
      gap: 10px;
    }
    .button-row button{
      flex:1;
      padding: 11px 10px;
      border:none;
      border-radius: 16px;
      font-weight: 900;
      cursor:pointer;
      transition: transform .18s ease, filter .18s ease;
      position: relative;
      overflow:hidden;
    }
    .button-row button::after{
      content:"";
      position:absolute;
      inset:-50px -50px auto auto;
      width:120px;height:120px;
      border-radius:999px;
      background: rgba(255,255,255,.22);
    }
    .button-row button > *{ position:relative; z-index:1; }
    .button-row button:hover{ filter: brightness(1.04); transform: translateY(-1px); }
    .button-row button:active{ transform: scale(.99); }

    .cancel-btn{ background: linear-gradient(135deg, #ef4444, #b91c1c); color:#fff; }
    .save-btn{ background: linear-gradient(135deg, #2563eb, #4f46e5); color:#fff; }

    /* ‚úÖ Save disable look */
    .save-btn[disabled]{
      opacity: .65;
      cursor: not-allowed;
      filter: grayscale(.25);
      transform: none !important;
    }

    /* ‚úÖ NEW: Image uploader UI (optional) */
    .img-row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(79,70,229,.03);
      margin-bottom: 12px;
    }
    .img-row .img-left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .img-row .img-left b{
      font-size: 12px;
      font-weight: 900;
      color: rgba(15,23,42,.78);
    }
    .img-row .img-left small{
      font-size: 11px;
      font-weight: 800;
      color: rgba(15,23,42,.58);
    }
    .img-row .pick-btn{
      border:none;
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 900;
      color:#fff;
      background: linear-gradient(135deg, #06b6d4, #4f46e5);
      box-shadow: 0 10px 18px rgba(15,23,42,.10);
      white-space:nowrap;
    }
    .img-row .pick-btn:active{ transform: scale(.99); }
    .img-preview{
      display:none;
      width: 100%;
      margin-top: -2px;
      margin-bottom: 12px;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.12);
      overflow:hidden;
      background: rgba(255,255,255,.95);
      box-shadow: 0 10px 22px rgba(15,23,42,.08);
    }
    .img-preview img{
      width: 100%;
      height: 140px;
      object-fit: cover;
      display:block;
    }
    .img-preview .cap{
      padding: 8px 10px;
      font-size: 11px;
      font-weight: 900;
      color: rgba(15,23,42,.70);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .img-preview .remove{
      border:none;
      cursor:pointer;
      font-weight: 900;
      border-radius: 12px;
      padding: 8px 10px;
      color:#fff;
      background: linear-gradient(135deg, #ef4444, #b91c1c);
    }

    /* ‚úÖ Table container */
    .show-box{
      width: min(1040px, 100%);
      margin: 14px auto 0 auto;
      padding: 0;
      border-radius: 20px;
      background: rgba(255,255,255,.94);
      border: 1px solid rgba(15,23,42,.16);
      box-shadow: var(--shadow2);
      overflow-x:auto;
    }

    /* ‚úÖ UPDATED: extra column */
    .table-wrapper{ width:100%; min-width: 1020px; }

    .transaction-table-header{
      display: table;
      width: 100%;
      table-layout: fixed;
      background: linear-gradient(90deg, rgba(79,70,229,.28), rgba(6,182,212,.22), rgba(34,197,94,.22), rgba(245,158,11,.20), rgba(236,72,153,.20));
      color: #0b1220;
      font-size: 13px;
      font-weight: 900;
      position: relative;
      overflow:hidden;
      border-bottom: 1px solid rgba(15,23,42,.18);
    }
    .transaction-table-header::after{
      content:"";
      position:absolute;
      inset:-80px -80px auto auto;
      width:200px;height:200px;
      border-radius:999px;
      background: rgba(255,255,255,.55);
      opacity:.9;
      transform: rotate(12deg);
    }
    .transaction-table-header > div{ position:relative; z-index:1; }

    .transaction-table-header div,
    .transaction-item div{
      display: table-cell;
      padding: 10px 14px;
      white-space: nowrap;
      vertical-align: middle;
      border-bottom: 1px solid rgba(15,23,42,.18);
      color: rgba(11,18,32,.92);
      font-weight: 800;
    }

    /* ‚úÖ column widths */
    .col-serial{ width: 64px; text-align:center; font-weight:900; color: rgba(15,23,42,.80); }
    .col-date{ width: 140px; }
    .col-time{ width: 110px; }
    .col-cat{ width: 160px; }
    .col-ac{ width: 140px; }
    .col-amt{ width: 120px; }
    .col-det{ width: 220px; }

    /* ‚úÖ NEW image column */
    .col-img{ width: 90px; text-align:center; }

    .col-act{ width: 120px; }

    #transactionBody{
      display: table-row-group;
      height:auto !important;
      max-height:none;
      overflow-y:visible;
    }

    .transaction-item{
      display: table;
      width:100%;
      table-layout: fixed;
      font-size: 13px;
      color: rgba(11,18,32,.95);
      background: #ffffff;
      transition: background .18s ease;
    }

    .transaction-item:nth-child(odd){
      background: linear-gradient(90deg, rgba(79,70,229,.08), rgba(56,189,248,.05), rgba(34,197,94,.05), rgba(255,255,255,0));
    }
    .transaction-item:nth-child(even){
      background: linear-gradient(90deg, rgba(236,72,153,.08), rgba(245,158,11,.05), rgba(6,182,212,.05), rgba(255,255,255,0));
    }
    .transaction-item:hover{
      background: linear-gradient(90deg, rgba(236,72,153,.10), rgba(245,158,11,.08), rgba(56,189,248,.08), rgba(255,255,255,.92));
    }

    .action-buttons{
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content:center;
    }
    .action-buttons button{
      border:none;
      padding: 7px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 15px;
      font-weight: 900;
      border: 1px solid rgba(15,23,42,.14);
      box-shadow: 0 10px 18px rgba(15,23,42,.10);
      transition: transform .16s ease, filter .16s ease;
      background: #fff;
    }
    .action-buttons button:hover{ filter: brightness(1.04); transform: translateY(-1px); }
    .action-buttons button:active{ transform: scale(.98); }

    .edit-btn{ background: linear-gradient(135deg, #2563eb, #4f46e5); color:#fff; border-color: rgba(79,70,229,.22); }
    .delete-btn{ background: linear-gradient(135deg, #ef4444, #b91c1c); color:#fff; border-color: rgba(239,68,68,.22); }

    /* ‚úÖ NEW: Image button */
    .img-btn{
      border:none;
      padding: 8px 10px;
      border-radius: 14px;
      cursor:pointer;
      font-size: 16px;
      font-weight: 900;
      border: 1px solid rgba(15,23,42,.14);
      box-shadow: 0 10px 18px rgba(15,23,42,.08);
      background: rgba(255,255,255,.95);
      transition: transform .16s ease, filter .16s ease;
    }
    .img-btn:hover{ filter: brightness(1.04); transform: translateY(-1px); }
    .img-btn:active{ transform: scale(.99); }
    .img-btn.noimg{
      opacity:.55;
      cursor: default;
      pointer-events:none;
    }

    /* Pagination */
    .page-size-area{
      width: min(1040px, 100%);
      margin: 10px auto 18px auto;
      padding: 12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      border-radius: 20px;
      background: rgba(255,255,255,.94);
      border: 1px solid rgba(15,23,42,.16);
      box-shadow: var(--shadow2);
      position: relative;
      overflow:hidden;
    }
    .page-size-area::after{
      content:"";
      position:absolute;
      inset:auto -90px -90px auto;
      width:220px;height:220px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(79,70,229,.12), rgba(6,182,212,.10), rgba(34,197,94,.10), rgba(236,72,153,.10));
      opacity:.95;
    }
    .page-size-area > *{ position:relative; z-index:1; }

    .pagination-controls{
      display:flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .pagination-controls .page-link{
      display:inline-block;
      padding: 8px 10px;
      border: 1px solid rgba(15,23,42,.14);
      border-radius: 14px;
      text-decoration:none;
      color: rgba(11,18,32,.82);
      font-size: 13px;
      font-weight: 900;
      background: rgba(255,255,255,.96);
      transition: transform .16s ease, background .16s ease, border-color .16s ease;
      cursor:pointer;
      min-width: 38px;
      text-align:center;
      box-shadow: 0 8px 16px rgba(15,23,42,.06);
      position: relative;
      overflow:hidden;
    }
    .pagination-controls .page-link::after{
      content:"";
      position:absolute;
      inset:-50px -50px auto auto;
      width:120px;height:120px;
      border-radius:999px;
      background: rgba(79,70,229,.10);
      opacity:.8;
    }
    .pagination-controls .page-link > *{ position:relative; z-index:1; }
    .pagination-controls .page-link:hover{
      transform: translateY(-1px);
      background: #ffffff;
      border-color: rgba(15,23,42,.24);
    }
    .pagination-controls .page-link.active-page{
      background: linear-gradient(135deg, rgba(37,99,235,.95), rgba(79,70,229,.92)) !important;
      color: #fff !important;
      border-color: rgba(79,70,229,.22) !important;
      transform:none !important;
      cursor: default;
      box-shadow: 0 12px 22px rgba(79,70,229,.18);
    }
    .pagination-controls .page-link.disabled-nav{
      opacity: .45;
      pointer-events:none;
    }

    .page-size-control{
      display:flex;
      align-items:center;
      gap: 8px;
      color: rgba(11,18,32,.72);
      font-size: 12px;
      font-weight: 900;
      white-space: nowrap;
    }
    #rowsPerPageSelect{
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.14);
      background: rgba(255,255,255,.96);
      color: rgba(11,18,32,.90);
      font-weight: 900;
      outline:none;
    }
    #rowsPerPageSelect option{ color:#0f172a; }

    /* Loader small (cards) */
    .loader-small{
      border: 3px solid rgba(15,23,42,.14);
      border-top: 3px solid rgba(79,70,229,.65);
      border-radius: 50%;
      width: 18px;
      height: 18px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    /* ‚úÖ NEW: Image Viewer Modal */
    .img-modal{
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 2000;
      padding: 16px;
      backdrop-filter: blur(10px);
    }
    .img-modal.open{ display:flex; }

    /* ‚úÖ CHANGED: fixed height ‡¶¨‡¶æ‡¶¶, ‡¶è‡¶ñ‡¶® max-height + auto */
    .img-modal-card{
      width: min(820px, 92vw);
      max-height: 92vh;                /* ‚úÖ viewport ‡¶è‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
      border-radius: 20px;
      background: rgba(255,255,255,.96);
      border: 1px solid rgba(15,23,42,.12);
      box-shadow: 0 20px 80px rgba(15,23,42,.24);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .img-modal-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(15,23,42,.10);
      background: linear-gradient(90deg, rgba(79,70,229,.10), rgba(6,182,212,.08), rgba(34,197,94,.08));
      flex: 0 0 auto;
    }
    .img-modal-top b{
      font-size: 12px;
      font-weight: 900;
      color: rgba(15,23,42,.80);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .img-modal-close{
      border:none;
      cursor:pointer;
      font-weight: 900;
      border-radius: 14px;
      padding: 8px 10px;
      color:#fff;
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      box-shadow: 0 10px 18px rgba(15,23,42,.10);
    }

    /* ‚úÖ CHANGED: body scrollable, ‡¶§‡¶æ‡¶á ‡¶≤‡¶Æ‡ßç‡¶¨‡¶æ ‡¶õ‡¶¨‡¶ø ‡¶ï‡¶æ‡¶ü‡¶¨‡ßá ‡¶®‡¶æ */
    .img-modal-body{
      flex: 1 1 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 12px;
      background: rgba(255,255,255,.95);
      overflow:auto;                   /* ‚úÖ tall image ‡¶π‡¶≤‡ßá scroll ‡¶π‡¶¨‡ßá */
    }

    /* ‚úÖ CHANGED: img container-fit */
    .img-modal-body img{
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: 16px;
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 14px 40px rgba(15,23,42,.16);
      background:#fff;
      display:block;
    }

    .img-modal-loading{
      font-weight: 900;
      color: rgba(15,23,42,.70);
      font-size: 12px;
    }

    /* Responsive */
    @media (max-width: 980px){
      .cards-container{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 520px){
      .nav-title h1{ font-size: 17px; }
      .nav-badge{ display:none; }
      .cards-container{ gap: 10px; }
      .card{ min-height: 84px; padding: 12px; border-radius: 18px; }
      .card p{ font-size: 18px; }
      .cash-buttons{ gap: 8px; }
      .cash-buttons button{ font-size: 10px; padding: 12px 8px; border-radius: 14px; }
      .img-preview img{ height: 130px; }
    }
  </style>
</head>

<body onload="initializeData()">

  <div class="navbar">
    <div class="nav-inner">
      <span class="menu-icon" onclick="toggleSidebar(event)">‚ò∞</span>

      <div class="nav-title">
        <h1>‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</h1>
        <small>Balance & Transactions</small>
      </div>

      <div class="nav-badge">
        <span class="dot"></span>
        <span>Realtime Firebase</span>
      </div>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sb-card">
      <h3>üìå Quick Menu</h3>
      <p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
    </div>
    <a href="index.html">üè† Dashboard</a>
    <a href="Dollar.html">üí∞ ‡¶°‡¶≤‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</a>
    <a href="Taka.html">üíµ ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</a>
  </div>

  <div class="main-content">
    <div class="cards-container">
      <div class="card card1"><p id="val-1"><span class="loader-small"></span></p><h3>‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</h3></div>
      <div class="card card2"><p id="val-2"><span class="loader-small"></span></p><h3>BanküèõÔ∏èTransfer</h3></div>
      <div class="card card3"><p id="val-3"><span class="loader-small"></span></p><h3>‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® ‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü </h3></div>
      <div class="card card4"><p id="val-4"><span class="loader-small"></span></p><h3>‡¶Ü‡¶ú‡¶ï‡ßá ‡¶°‡ßÅ‡¶ï‡¶õ‡ßá</h3></div>
      <div class="card card5"><p id="val-5"><span class="loader-small"></span></p><h3>‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</h3></div>
      <div class="card card6"><p id="val-6"><span class="loader-small"></span></p><h3>‡¶®‡¶ó‡¶¶</h3></div>
      <div class="card card7"><p id="val-7"><span class="loader-small"></span></p><h3>‡¶∞‡¶ï‡ßá‡¶ü</h3></div>
      <div class="card card8"><p id="val-8"><span class="loader-small"></span></p><h3>Today Charge</h3></div>
    </div>
  </div>

  <div class="cash-buttons">
    <button class="cash-in-btn" onclick="openForm('in')">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶°‡ßÅ‡¶ï‡¶æ‡¶®‡ßã‚ûï</button>
    <button class="cash-out-btn" onclick="openForm('out')">‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ üè¢</button>
    <button class="c-convert" onclick="openForm('c-out')">Convertüí±</button>
    <button class="t-b2b" onclick="openForm('b2b')">‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü +</button>
  </div>

  <div id="formContainer" class="popup-form" style="display:none;">
    <div id="formIn" class="form-content" style="display:none;">
      <h1 class="takad-text">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶°‡ßÅ‡¶ï‡¶æ‡¶®‡ßã</h1>
      <div class="row-line-time">
        <div class="time-box">
          <span id="showTimeIn">--:-- AM</span>
          <input type="time" id="timePickerIn" class="hidden-picker" onchange="updateTime('In')">
          <img src="https://cdn-icons-png.flaticon.com/512/2088/2088617.png" class="icon">
        </div>
        <div class="date-box">
          <span id="showDateIn">--/--/----</span>
          <input type="date" id="datePickerIn" class="hidden-picker" onchange="updateDate('In')">
          <img src="https://cdn-icons-png.flaticon.com/512/2838/2838779.png" class="icon">
        </div>
      </div>
      <div class="row-line-type">
        <select class="account-type-a" id="incategory"><option>‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</option><option>‡¶®‡¶ó‡¶¶</option><option>‡¶∞‡¶ï‡ßá‡¶ü</option></select>
        <select class="account-type-b" id="type-ac"><option>‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßã‡¶®‡¶æ‡¶≤</option><option>‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü B2B</option><option>‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö‡ßá‡¶®‡ßç‡¶ü</option></select>
      </div>
      <div class="amount-section">
        <label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶®</label>
        <div class="taka-input"><input type="number" placeholder="‡ß≥0.00" id="intaka-f"></div>
      </div>

      <!-- ‚úÖ NEW optional image -->
      <div class="img-row">
        <div class="img-left">
          <b>‡¶õ‡¶¨‡¶ø (Optional)</b>
          <small>‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®</small>
        </div>
        <button class="pick-btn" type="button" onclick="document.getElementById('inImageFile').click()">Pick</button>
        <input id="inImageFile" type="file" accept="image/*" style="display:none" onchange="handleImagePick('in')">
      </div>
      <div id="inImagePreview" class="img-preview">
        <img id="inImagePreviewImg" src="" alt="preview">
        <div class="cap">
          <span id="inImagePreviewName">image</span>
          <button class="remove" type="button" onclick="removePickedImage('in')">Remove</button>
        </div>
      </div>

      <input type="text" id="inDescription" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶¶‡¶ø‡¶®">
      <div class="button-row">
        <button class="cancel-btn" onclick="closeForm()">Cancel</button>
        <button class="save-btn" id="saveBtnIn" onclick="saveIn()">Save</button>
      </div>
    </div>

    <div id="formOut" class="form-content" style="display:none;">
      <h1 class="takad-text">‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶∏‡¶´‡¶æ‡¶∞ üè¢</h1>
      <div class="row-line-time">
        <div class="time-box">
          <span id="showTimeOut">--:-- AM</span>
          <input type="time" id="timePickerOut" class="hidden-picker" onchange="updateTime('Out')">
          <img src="https://cdn-icons-png.flaticon.com/512/2088/2088617.png" class="icon">
        </div>
        <div class="date-box">
          <span id="showDateOut">--/--/----</span>
          <input type="date" id="datePickerOut" class="hidden-picker" onchange="updateDate('Out')">
          <img src="https://cdn-icons-png.flaticon.com/512/2838/2838779.png" class="icon">
        </div>
      </div>
      <div class="row-line-type">
        <select class="account-type-a" id="outcategory"><option>Bank Transfer</option><option>‡¶π‡ßá‡¶®‡ßç‡¶° ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂</option></select>
        <select class="account-type-b" id="type-ac-out"><option>Brack Bank</option><option>City Bank</option><option>Hand Cash</option></select>
      </div>
      <div class="amount-section">
        <label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶®</label>
        <div class="taka-input"><input type="number" placeholder="‡ß≥0.00" id="outtaka-f"></div>
      </div>

      <!-- ‚úÖ NEW optional image -->
      <div class="img-row">
        <div class="img-left">
          <b>‡¶õ‡¶¨‡¶ø (Optional)</b>
          <small>‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®</small>
        </div>
        <button class="pick-btn" type="button" onclick="document.getElementById('outImageFile').click()">Pick</button>
        <input id="outImageFile" type="file" accept="image/*" style="display:none" onchange="handleImagePick('out')">
      </div>
      <div id="outImagePreview" class="img-preview">
        <img id="outImagePreviewImg" src="" alt="preview">
        <div class="cap">
          <span id="outImagePreviewName">image</span>
          <button class="remove" type="button" onclick="removePickedImage('out')">Remove</button>
        </div>
      </div>

      <input type="text" id="outDescription" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶¶‡¶ø‡¶®">
      <div class="button-row">
        <button class="cancel-btn" onclick="closeForm()">Cancel</button>
        <button class="save-btn" id="saveBtnOut" onclick="saveOut()">Save</button>
      </div>
    </div>

    <div id="formCOut" class="form-content" style="display:none;">
      <h1 class="takad-text">Convertüí±</h1>
      <div class="row-line-time">
        <div class="time-box">
          <span id="showTimeCOut">--:-- AM</span>
          <input type="time" id="timePickerCOut" class="hidden-picker" onchange="updateTime('COut')">
          <img src="https://cdn-icons-png.flaticon.com/512/2088/2088617.png" class="icon">
        </div>
        <div class="date-box">
          <span id="showDateCOut">--/--/----</span>
          <input type="date" id="datePickerCOut" class="hidden-picker" onchange="updateDate('COut')">
          <img src="https://cdn-icons-png.flaticon.com/512/2838/2838779.png" class="icon">
        </div>
      </div>
      <div class="row-line-type">
        <select class="account-type-a" id="ccategory"><option>‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</option><option>‡¶®‡¶ó‡¶¶</option><option>‡¶∞‡¶ï‡ßá‡¶ü</option></select>
        <select class="account-type-b" id="type-ac-c"><option>‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</option></select>
      </div>
      <div class="amount-section">
        <div class="taka-input"><input type="number" placeholder="‡ß≥0.00" id="intaka-f-c"></div>
        <div class="charge-section" style="margin-top:10px;">
          <div class="charge-input"><input type="number" placeholder="charge 0" id="charge-c"></div>
        </div>
      </div>

      <!-- ‚úÖ NEW optional image -->
      <div class="img-row">
        <div class="img-left">
          <b>‡¶õ‡¶¨‡¶ø (Optional)</b>
          <small>‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®</small>
        </div>
        <button class="pick-btn" type="button" onclick="document.getElementById('cImageFile').click()">Pick</button>
        <input id="cImageFile" type="file" accept="image/*" style="display:none" onchange="handleImagePick('c')">
      </div>
      <div id="cImagePreview" class="img-preview">
        <img id="cImagePreviewImg" src="" alt="preview">
        <div class="cap">
          <span id="cImagePreviewName">image</span>
          <button class="remove" type="button" onclick="removePickedImage('c')">Remove</button>
        </div>
      </div>

      <input type="text" id="cDescription" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶¶‡¶ø‡¶®">
      <div class="button-row">
        <button class="cancel-btn" onclick="closeForm()">Cancel</button>
        <button class="save-btn" id="saveBtnC" onclick="saveCOut()">Save</button>
      </div>
    </div>

    <div id="formB2B" class="form-content" style="display:none;">
      <h1 class="takad-text">‡¶™‡ßç‡¶∞‡¶´‡¶ø‡¶ü +</h1>
      <div class="row-line-time">
        <div class="time-box">
          <span id="showTimeB2B">--:-- AM</span>
          <input type="time" id="timePickerB2B" class="hidden-picker" onchange="updateTime('B2B')">
          <img src="https://cdn-icons-png.flaticon.com/512/2088/2088617.png" class="icon">
        </div>
        <div class="date-box">
          <span id="showDateB2B">--/--/----</span>
          <input type="date" id="datePickerB2B" class="hidden-picker" onchange="updateDate('B2B')">
          <img src="https://cdn-icons-png.flaticon.com/512/2838/2838779.png" class="icon">
        </div>
      </div>
      <div class="row-line-type">
        <select class="account-type-a" id="b2bcategory"><option>‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</option><option>‡¶®‡¶ó‡¶¶</option><option>‡¶∞‡¶ï‡ßá‡¶ü</option></select>
        <select class="account-type-b" id="type-ac-b2b"><option>‡¶ü‡¶æ‡¶ï‡¶æ In</option><option>‡¶ü‡¶æ‡¶ï‡¶æ Out</option></select>
      </div>
      <div class="amount-section">
        <div class="taka-input"><input type="number" placeholder="‡ß≥0.00" id="intaka-f-b2b"></div>
      </div>

      <!-- ‚úÖ NEW optional image -->
      <div class="img-row">
        <div class="img-left">
          <b>‡¶õ‡¶¨‡¶ø (Optional)</b>
          <small>‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®</small>
        </div>
        <button class="pick-btn" type="button" onclick="document.getElementById('b2bImageFile').click()">Pick</button>
        <input id="b2bImageFile" type="file" accept="image/*" style="display:none" onchange="handleImagePick('b2b')">
      </div>
      <div id="b2bImagePreview" class="img-preview">
        <img id="b2bImagePreviewImg" src="" alt="preview">
        <div class="cap">
          <span id="b2bImagePreviewName">image</span>
          <button class="remove" type="button" onclick="removePickedImage('b2b')">Remove</button>
        </div>
      </div>

      <input type="text" id="b2bDescription" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶¶‡¶ø‡¶®">
      <div class="button-row">
        <button class="cancel-btn" onclick="closeForm()">Cancel</button>
        <button class="save-btn" id="saveBtnB2B" onclick="saveB2B()">Save</button>
      </div>
    </div>
  </div>

  <div class="show-box">
    <div class="table-wrapper">
      <div class="transaction-table-header">
        <div class="col-serial">#</div>
        <div class="col-date">Date</div>
        <div class="col-time">Time</div>
        <div class="col-cat">Category</div>
        <div class="col-ac">D. A/C</div>
        <div class="col-amt">Amount</div>
        <div class="col-det">Details</div>
        <div class="col-img">Image</div>
        <div class="col-act">Action</div>
      </div>

      <div id="transactionBody">
        <div style="text-align:center; padding:20px; display:table; width:100%; table-layout:fixed;">
          <div style="display:table-cell; padding:18px; color:rgba(15,23,42,.65); font-weight:900;">
            ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá, ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="page-size-area">
    <div class="pagination-controls"></div>
    <div class="page-size-control">
      <label for="rowsPerPageSelect">‡¶≤‡¶æ‡¶á‡¶® ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ:</label>
      <select id="rowsPerPageSelect" onchange="changeRowsPerPage(this.value)">
        <option value="10" selected>10</option>
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </div>
  </div>

  <!-- ‚úÖ NEW: Image Viewer Modal -->
  <div id="imgModal" class="img-modal" onclick="closeImageModalByBackdrop(event)">
    <div class="img-modal-card">
      <div class="img-modal-top">
        <b id="imgModalTitle">Image View</b>
        <button class="img-modal-close" type="button" onclick="closeImageModal()">Close ‚úï</button>
      </div>
      <div class="img-modal-body">
        <div id="imgModalLoading" class="img-modal-loading" style="display:none;">‡¶õ‡¶¨‡¶ø ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
        <img id="imgModalImg" src="" alt="full" style="display:none;">
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from './firebase-config.js';
    import { ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const balancesRef = ref(db, 'takaBalances');
    const transactionsRef = ref(db, 'takaTransactions');

    // ‚úÖ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Worker URL (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞‡¶ü‡¶æ ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶¨‡¶¶‡¶≤‡¶æ‡¶¨‡ßá‡¶® ‡¶®‡¶æ)
    const TELEGRAM_WORKER_BASE = "https://cold-leaf-38d2.sksohansheet.workers.dev";

    let balances = {
      total: 0, bank: 0, b2b: 0, todayIn: 0, bkash: 0, nagad: 0, rocket: 0, todayCharge: 0, lastUpdateDate: new Date().toLocaleDateString('en-US')
    };
    let transactions = [];
    let currentPage = 1;
    let currentRowsPerPage = 10;
    let currentEditId = null;

    // ‚úÖ NEW: ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ
    let transactionsLoaded = false;

    // ‚úÖ NEW: multi-save lock
    let isSaving = false;

    // ‚úÖ NEW: edit mode ‡¶è existing image ‡¶ß‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
    const existingImageByKind = { in:null, out:null, c:null, b2b:null };

    // ‚úÖ NEW: card money formatter
    function formatCardMoney(n) {
      const num = Number(n || 0);
      return num.toLocaleString('en-US');
    }

    // --- ‚úÖ NEW: Image Pick/Preview helpers (Optional) ---
    const IMG_MAP = {
      in:   { input: 'inImageFile',   box: 'inImagePreview',   img: 'inImagePreviewImg',   name: 'inImagePreviewName' },
      out:  { input: 'outImageFile',  box: 'outImagePreview',  img: 'outImagePreviewImg',  name: 'outImagePreviewName' },
      c:    { input: 'cImageFile',    box: 'cImagePreview',    img: 'cImagePreviewImg',    name: 'cImagePreviewName' },
      b2b:  { input: 'b2bImageFile',  box: 'b2bImagePreview',  img: 'b2bImagePreviewImg',  name: 'b2bImagePreviewName' }
    };

    function setSavingUI(on){
      const form = document.getElementById('formContainer');
      if(!form) return;
      const saveBtns = form.querySelectorAll('.save-btn');
      saveBtns.forEach(btn => {
        if(on){
          if(!btn.dataset.origText) btn.dataset.origText = btn.textContent;
          btn.textContent = "Saving...";
          btn.disabled = true;
        }else{
          btn.textContent = btn.dataset.origText || "Save";
          btn.disabled = false;
        }
      });
    }

    function clearExistingImageMeta(){
      existingImageByKind.in = null;
      existingImageByKind.out = null;
      existingImageByKind.c = null;
      existingImageByKind.b2b = null;
    }

    function showExistingImage(kind, imageMeta){
      const m = IMG_MAP[kind];
      if(!m) return;

      const box = document.getElementById(m.box);
      const img = document.getElementById(m.img);
      const nm  = document.getElementById(m.name);

      if(!box || !img || !nm) return;

      if(imageMeta && imageMeta.file_id){
        existingImageByKind[kind] = imageMeta;

        const url = `${TELEGRAM_WORKER_BASE}/file?file_id=${encodeURIComponent(imageMeta.file_id)}`;
        img.src = url;
        nm.textContent = "Saved Image";
        box.style.display = "block";
      } else {
        existingImageByKind[kind] = null;
        img.src = "";
        box.style.display = "none";
      }
    }

    window.handleImagePick = function(kind){
      const m = IMG_MAP[kind];
      if(!m) return;

      // ‡¶®‡¶§‡ßÅ‡¶® ‡¶õ‡¶¨‡¶ø pick ‡¶ï‡¶∞‡¶≤‡ßá existing image ‡¶Ü‡¶∞ ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶¨‡ßá ‡¶®‡¶æ
      existingImageByKind[kind] = null;

      const inp = document.getElementById(m.input);
      const file = inp?.files?.[0];
      const box = document.getElementById(m.box);
      const img = document.getElementById(m.img);
      const nm  = document.getElementById(m.name);
      if(!file){
        if(box) box.style.display = "none";
        return;
      }
      const url = URL.createObjectURL(file);
      img.src = url;
      nm.textContent = (file.name || "image").slice(0, 22);
      box.style.display = "block";
    };

    window.removePickedImage = function(kind){
      const m = IMG_MAP[kind];
      if(!m) return;

      // ‚úÖ remove ‡¶ö‡¶æ‡¶™‡¶≤‡ßá existing image ‡¶ì clear ‡¶π‡¶¨‡ßá
      existingImageByKind[kind] = null;

      const inp = document.getElementById(m.input);
      const box = document.getElementById(m.box);
      const img = document.getElementById(m.img);
      const nm  = document.getElementById(m.name);

      if(inp) inp.value = "";
      if(img) img.src = "";
      if(nm) nm.textContent = "image";
      if(box) box.style.display = "none";
    };

    function getPickedFile(kind){
      const m = IMG_MAP[kind];
      if(!m) return null;
      const inp = document.getElementById(m.input);
      return inp?.files?.[0] || null;
    }

    function clearAllPickedImages(){
      ['in','out','c','b2b'].forEach(k => window.removePickedImage(k));
    }

    // ‚úÖ NEW: Telegram upload via Worker (no token in frontend)
    async function postImageToTelegram(file, caption){
      const fd = new FormData();
      fd.append('photo', file);
      fd.append('caption', caption || '');

      const res = await fetch(`${TELEGRAM_WORKER_BASE}/sendPhoto`, {
        method: 'POST',
        body: fd
      });

      if(!res.ok){
        throw new Error("Worker upload failed: " + res.status);
      }
      const data = await res.json();
      if(!data || data.ok !== true || !data.file_id){
        throw new Error("Worker response invalid");
      }
      return data; // { ok:true, file_id, message_id }
    }

    // ‚úÖ NEW: Modal viewer
    window.openImageModal = async function(t){
      try{
        const modal = document.getElementById('imgModal');
        const title = document.getElementById('imgModalTitle');
        const img = document.getElementById('imgModalImg');
        const loading = document.getElementById('imgModalLoading');

        title.textContent = `Image ‚Ä¢ ${t?.date || ''} ${t?.time || ''}`;
        img.style.display = "none";
        loading.style.display = "block";
        modal.classList.add('open');

        const fileId = t?.image?.file_id;
        if(!fileId){
          loading.textContent = "‡¶ï‡ßã‡¶® ‡¶õ‡¶¨‡¶ø ‡¶®‡ßá‡¶á";
          return;
        }

        const url = `${TELEGRAM_WORKER_BASE}/file?file_id=${encodeURIComponent(fileId)}`;
        img.onload = () => {
          loading.style.display = "none";
          img.style.display = "block";
        };
        img.onerror = () => {
          loading.textContent = "‡¶õ‡¶¨‡¶ø ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø (Worker/Telegram check ‡¶ï‡¶∞‡ßÅ‡¶®)";
        };
        img.src = url;
      }catch(e){
        alert("Image open error");
      }
    };

    window.closeImageModal = function(){
      const modal = document.getElementById('imgModal');
      const img = document.getElementById('imgModalImg');
      const loading = document.getElementById('imgModalLoading');
      modal.classList.remove('open');
      img.src = "";
      img.style.display = "none";
      loading.style.display = "none";
      loading.textContent = "‡¶õ‡¶¨‡¶ø ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
    };

    window.closeImageModalByBackdrop = function(e){
      if(e?.target?.id === "imgModal") window.closeImageModal();
    };

    // --- ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ ---
    window.initializeData = function() {
      loadDataFromFirebase();
      initializeDateTime();
    };

    window.toggleSidebar = function(event) {
      if (event) event.stopPropagation();
      document.getElementById('sidebar').classList.toggle('open');
    };

    window.openForm = function(type) {
      document.querySelectorAll('.form-content').forEach(f => f.style.display = 'none');
      document.getElementById('formContainer').style.display = 'flex';

      if (type === 'in') document.getElementById('formIn').style.display = 'block';
      else if (type === 'out') document.getElementById('formOut').style.display = 'block';
      else if (type === 'c-out') document.getElementById('formCOut').style.display = 'block';
      else if (type === 'b2b') document.getElementById('formB2B').style.display = 'block';
    };

    /* ‚úÖ CHANGED: force parameter ‡¶Ø‡ßã‡¶ó */
    window.closeForm = function(force=false) {
      // ‚úÖ saving ‡¶ö‡¶≤‡¶æ‡¶ï‡¶æ‡¶≤‡ßÄ‡¶® close prevent (‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ force=true ‡¶π‡¶≤‡ßá ‡¶¨‡¶®‡ßç‡¶ß ‡¶π‡¶¨‡ßá)
      if(isSaving && !force) return;

      document.getElementById('formContainer').style.display = 'none';
      currentEditId = null;
      resetFormFields();
    };

    window.updateDate = function(type) {
      const val = document.getElementById(`datePicker${type}`).value;
      if (val) {
        const d = new Date(val);
        const formattedDate = String(d.getDate()).padStart(2, '0') + '/' + String(d.getMonth() + 1).padStart(2, '0') + '/' + d.getFullYear();
        document.getElementById(`showDate${type}`).textContent = formattedDate;
      }
    };

    window.updateTime = function(type) {
      const val = document.getElementById(`timePicker${type}`).value;
      if (val) {
        const [h, m] = val.split(':');
        const d = new Date(); d.setHours(h); d.setMinutes(m);
        document.getElementById(`showTime${type}`).textContent = d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
      }
    };

    // ‚úÖ Save buttons (‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§, ‡¶∂‡ßÅ‡¶ß‡ßÅ multi-click prevent)
    window.saveIn = async function() {
      if(isSaving) return;
      isSaving = true; setSavingUI(true);

      try{
        await saveTransaction('in', {
          date: document.getElementById('showDateIn').textContent,
          time: document.getElementById('showTimeIn').textContent,
          cat: document.getElementById('incategory').value,
          account: document.getElementById('type-ac').value,
          amount: parseFloat(document.getElementById('intaka-f').value) || 0,
          details: document.getElementById('inDescription').value
        }, 'in');
      } finally {
        isSaving = false; setSavingUI(false);
      }
    };

    window.saveOut = async function() {
      if(isSaving) return;
      isSaving = true; setSavingUI(true);

      try{
        await saveTransaction('out', {
          date: document.getElementById('showDateOut').textContent,
          time: document.getElementById('showTimeOut').textContent,
          cat: document.getElementById('outcategory').value,
          account: document.getElementById('type-ac-out').value,
          amount: -(parseFloat(document.getElementById('outtaka-f').value) || 0),
          details: document.getElementById('outDescription').value
        }, 'out');
      } finally {
        isSaving = false; setSavingUI(false);
      }
    };

    window.saveCOut = async function() {
      if(isSaving) return;
      isSaving = true; setSavingUI(true);

      try{
        await saveTransaction('convert', {
          date: document.getElementById('showDateCOut').textContent,
          time: document.getElementById('showTimeCOut').textContent,
          cat: document.getElementById('ccategory').value,
          account: "Convert",
          amount: parseFloat(document.getElementById('intaka-f-c').value) || 0,
          charge: parseFloat(document.getElementById('charge-c').value) || 0,
          details: document.getElementById('cDescription').value
        }, 'c');
      } finally {
        isSaving = false; setSavingUI(false);
      }
    };

    window.saveB2B = async function() {
      if(isSaving) return;
      isSaving = true; setSavingUI(true);

      try{
        const amt = parseFloat(document.getElementById('intaka-f-b2b').value) || 0;
        const bType = document.getElementById('type-ac-b2b').value;
        await saveTransaction('b2b', {
          date: document.getElementById('showDateB2B').textContent,
          time: document.getElementById('showTimeB2B').textContent,
          cat: document.getElementById('b2bcategory').value,
          account: "B2B " + bType,
          amount: bType === "‡¶ü‡¶æ‡¶ï‡¶æ In" ? amt : -amt,
          details: document.getElementById('b2bDescription').value
        }, 'b2b');
      } finally {
        isSaving = false; setSavingUI(false);
      }
    };

    window.deleteTransaction = function(id) {
      if(confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶è‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
        const idx = transactions.findIndex(t => t.id == id);
        if (idx > -1) {
          adjustBalances(transactions[idx], true);
          transactions.splice(idx, 1);
          updateFirebase();
        }
      }
    };

    window.editTransaction = function(id) {
      const t = transactions.find(x => x.id == id);
      if(!t) return;
      currentEditId = id;

      // ‚úÖ edit open ‡¶π‡¶≤‡ßá picked file clear (‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®)
      clearAllPickedImages();
      // ‚úÖ existing meta reset
      clearExistingImageMeta();

      const safeDate = (t.date || "").includes('/') ? t.date : "01/01/1970";
      const dateParts = safeDate.split('/');
      const formattedDate = `${dateParts[2] || "1970"}-${(dateParts[1] || "01")}-${(dateParts[0] || "01")}`;

      if(t.type === 'in') {
        window.openForm('in');
        document.getElementById('datePickerIn').value = formattedDate;
        window.updateDate('In');
        document.getElementById('incategory').value = t.cat;
        document.getElementById('type-ac').value = t.account;
        document.getElementById('intaka-f').value = t.amount;
        document.getElementById('inDescription').value = t.details;

        // ‚úÖ edit ‡¶è ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø ‡¶∂‡ßã
        showExistingImage('in', t.image || null);

      } else if(t.type === 'out') {
        window.openForm('out');
        document.getElementById('datePickerOut').value = formattedDate;
        window.updateDate('Out');
        document.getElementById('outcategory').value = t.cat;
        document.getElementById('type-ac-out').value = t.account;
        document.getElementById('outtaka-f').value = Math.abs(t.amount);
        document.getElementById('outDescription').value = t.details;

        showExistingImage('out', t.image || null);

      } else if(t.type === 'convert') {
        window.openForm('c-out');
        document.getElementById('datePickerCOut').value = formattedDate;
        window.updateDate('COut');
        document.getElementById('ccategory').value = t.cat;
        document.getElementById('intaka-f-c').value = t.amount;
        document.getElementById('charge-c').value = t.charge;
        document.getElementById('cDescription').value = t.details;

        showExistingImage('c', t.image || null);

      } else if(t.type === 'b2b') {
        window.openForm('b2b');
        document.getElementById('datePickerB2B').value = formattedDate;
        window.updateDate('B2B');
        document.getElementById('b2bcategory').value = t.cat;
        document.getElementById('intaka-f-b2b').value = Math.abs(t.amount);
        document.getElementById('type-ac-b2b').value = t.amount >= 0 ? "‡¶ü‡¶æ‡¶ï‡¶æ In" : "‡¶ü‡¶æ‡¶ï‡¶æ Out";
        document.getElementById('b2bDescription').value = t.details;

        showExistingImage('b2b', t.image || null);
      }
    };

    window.changeRowsPerPage = function(val) {
      currentRowsPerPage = parseInt(val);
      currentPage = 1;
      displayTransactions();
      setupPagination();
    };

    window.changePage = function(page) {
      const totalPages = Math.ceil(transactions.length / currentRowsPerPage);
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displayTransactions();
        setupPagination();
      }
    };

    // --- ‚úÖ ‡¶è‡¶á ‡¶™‡ßá‡¶ú‡ßá‡¶∞ ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶•‡ßá‡¶ï‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ "‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ (val-1)" ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ---
    function computeTakaOnlyTotal() {
      let total = 0;
      for (const t of transactions) {
        if (!t) continue;
        const type = t.type;
        const amt = Number(t.amount || 0);

        if (type === 'in') {
          if (t.account !== "‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßã‡¶®‡¶æ‡¶≤") total += amt;
        } else if (type === 'out') {
          total -= Math.abs(amt);
        } else if (type === 'convert') {
          total += amt;
        }
      }
      return total;
    }

    // --- ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡¶æ‡¶≤ ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---
    function loadDataFromFirebase() {
      onValue(balancesRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          balances = data;
          checkDailyReset();
          refreshUI();
        } else {
          balances = { total: 0, bank: 0, b2b: 0, todayIn: 0, bkash: 0, nagad: 0, rocket: 0, todayCharge: 0, lastUpdateDate: new Date().toLocaleDateString('en-US') };
          refreshUI();
        }
      });

      onValue(transactionsRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          if (Array.isArray(data)) {
            transactions = data.filter(Boolean).map((t, i) => ({ id: t?.id ?? (t?.id === 0 ? 0 : (Date.now() + i)), ...t }));
          } else {
            transactions = Object.entries(data)
              .filter(([_, v]) => v)
              .map(([key, v]) => ({ id: v.id ?? key, ...v }));
          }
        } else {
          transactions = [];
        }

        transactionsLoaded = true;
        sortTransactions();

        const totalPages = Math.max(1, Math.ceil(transactions.length / currentRowsPerPage));
        if (currentPage > totalPages) currentPage = totalPages;

        balances.total = computeTakaOnlyTotal();

        displayTransactions();
        setupPagination();
        refreshUI();
      });
    }

    // ‚úÖ FIX: daily reset ‡¶è ‡¶Ø‡ßá‡¶® transactions overwrite ‡¶®‡¶æ ‡¶π‡ßü
    function updateBalancesOnly() {
      set(balancesRef, balances);
    }

    function updateFirebase() {
      set(balancesRef, balances);
      set(transactionsRef, transactions);
    }

    function checkDailyReset() {
      const today = new Date().toLocaleDateString('en-US');
      if (balances.lastUpdateDate !== today) {
        balances.bank = 0; balances.todayIn = 0; balances.todayCharge = 0;
        balances.lastUpdateDate = today;

        // ‚úÖ FIX: ‡¶Ü‡¶ó‡ßá updateFirebase() ‡¶õ‡¶ø‡¶≤ (transactions empty ‡¶•‡¶æ‡¶ï‡¶≤‡ßá wipe ‡¶π‡¶§‡ßã)
        updateBalancesOnly();
      }
    }

    function initializeDateTime() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const hh = String(today.getHours()).padStart(2, '0');
      const min = String(today.getMinutes()).padStart(2, '0');

      ['In', 'Out', 'COut', 'B2B'].forEach(type => {
        const dp = document.getElementById(`datePicker${type}`);
        const tp = document.getElementById(`timePicker${type}`);
        if(dp) dp.value = `${yyyy}-${mm}-${dd}`;
        if(tp) tp.value = `${hh}:${min}`;
        window.updateDate(type);
        window.updateTime(type);
      });
    }

    function refreshUI() {
      if (!transactionsLoaded) return;

      if (transactions.length === 0) {
        document.getElementById('val-1').innerText = `‡ß≥ ${formatCardMoney(0)}`;
        document.getElementById('val-2').innerText = `‡ß≥ ${formatCardMoney(0)}`;
        document.getElementById('val-3').innerText = `‡ß≥ ${formatCardMoney(0)}`;
        document.getElementById('val-4').innerText = `‡ß≥ ${formatCardMoney(0)}`;
        document.getElementById('val-5').innerText = `‡ß≥ ${formatCardMoney(0)}`;
        document.getElementById('val-6').innerText = `‡ß≥ ${formatCardMoney(0)}`;
        document.getElementById('val-7').innerText = `‡ß≥ ${formatCardMoney(0)}`;
        document.getElementById('val-8').innerText = `‡ß≥ ${formatCardMoney(0)}`;
        return;
      }

      const takaOnlyTotal = computeTakaOnlyTotal();
      document.getElementById('val-1').innerText = `‡ß≥ ${formatCardMoney(takaOnlyTotal || 0)}`;

      document.getElementById('val-2').innerText = `‡ß≥ ${formatCardMoney(balances.bank || 0)}`;
      document.getElementById('val-3').innerText = `‡ß≥ ${formatCardMoney(balances.b2b || 0)}`;
      document.getElementById('val-4').innerText = `‡ß≥ ${formatCardMoney(balances.todayIn || 0)}`;
      document.getElementById('val-5').innerText = `‡ß≥ ${formatCardMoney(balances.bkash || 0)}`;
      document.getElementById('val-6').innerText = `‡ß≥ ${formatCardMoney(balances.nagad || 0)}`;
      document.getElementById('val-7').innerText = `‡ß≥ ${formatCardMoney(balances.rocket || 0)}`;
      document.getElementById('val-8').innerText = `‡ß≥ ${formatCardMoney(balances.todayCharge || 0)}`;
    }

    function sortTransactions() {
      transactions.sort((a, b) => {
        const aDate = (a?.date && typeof a.date === 'string') ? a.date : "01/01/1970";
        const bDate = (b?.date && typeof b.date === 'string') ? b.date : "01/01/1970";

        const dateA = aDate.split('/').reverse().join('-');
        const dateB = bDate.split('/').reverse().join('-');
        if (dateA > dateB) return -1;
        if (dateA < dateB) return 1;

        const timeA = convertTo24Hour(a?.time);
        const timeB = convertTo24Hour(b?.time);
        return timeB.localeCompare(timeA);
      });
    }

    function convertTo24Hour(timeStr) {
      if(!timeStr || typeof timeStr !== 'string') return "00:00";
      const parts = timeStr.split(' ');
      const time = parts[0] || "00:00";
      const modifier = parts[1] || "AM";
      let [hours, minutes] = time.split(':');
      hours = hours || "00"; minutes = minutes || "00";
      if (hours === '12') hours = '00';
      if (modifier === 'PM') hours = String(parseInt(hours, 10) + 12);
      return `${String(hours).padStart(2, '0')}:${minutes}`;
    }

    function resetFormFields() {
      document.querySelectorAll('#formContainer input[type="number"], #formContainer input[type="text"]').forEach(i => i.value = "");
      document.querySelectorAll('#formContainer select').forEach(s => { if(s.id !== 'rowsPerPageSelect') s.selectedIndex = 0; });

      clearExistingImageMeta();
      clearAllPickedImages();

      initializeDateTime();
    }

    function adjustBalances(t, reverse = false) {
      const factor = reverse ? -1 : 1;
      const amount = t.amount;
      const charge = t.charge || 0;
      const today = new Date().toLocaleDateString('en-GB').replace(/\//g, '/');
      const isToday = (t.date === today);

      if (t.type === 'in') {
        if (t.account === "‡¶™‡¶æ‡¶∞‡ßç‡¶∏‡ßã‡¶®‡¶æ‡¶≤") {
          if (t.cat === "‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂") balances.bkash += (amount * factor);
          else if (t.cat === "‡¶®‡¶ó‡¶¶") balances.nagad += (amount * factor);
          else if (t.cat === "‡¶∞‡¶ï‡ßá‡¶ü") balances.rocket += (amount * factor);
        } else { balances.total += (amount * factor); }
        if(isToday) balances.todayIn += (amount * factor);
      } else if (t.type === 'out') {
        const absAmt = Math.abs(amount);
        balances.total -= (absAmt * factor);
        if (t.cat === "Bank Transfer" && isToday) balances.bank += (absAmt * factor);
      } else if (t.type === 'convert') {
        const totalOut = amount + charge;
        if (t.cat === "‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂") balances.bkash -= (totalOut * factor);
        else if (t.cat === "‡¶®‡¶ó‡¶¶") balances.nagad -= (totalOut * factor);
        else if (t.cat === "‡¶∞‡¶ï‡ßá‡¶ü") balances.rocket -= (totalOut * factor);
        balances.total += (amount * factor);
        if(isToday) balances.todayCharge += (charge * factor);
      } else if (t.type === 'b2b') {
        balances.b2b += (amount * factor);
      }
    }

    // ‚úÖ IMPORTANT: ‡¶™‡ßÅ‡¶∞‡¶®‡ßã saveTransaction ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶è‡¶ï‡¶á ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
    // ‡¶∂‡ßÅ‡¶ß‡ßÅ image ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶Ü‡¶ó‡ßá worker ‡¶è upload ‡¶ï‡¶∞‡ßá file_id store ‡¶ï‡¶∞‡¶¨‡ßá
    async function saveTransaction(type, data, imageKind) {

      // ---- keep old balances behavior
      if(currentEditId){
        const oldIdx = transactions.findIndex(t => t.id == currentEditId);
        if(oldIdx !== -1){
          adjustBalances(transactions[oldIdx], true);
          transactions.splice(oldIdx, 1);
        }
      }

      // ‚úÖ NEW: optional image upload
      let imageMeta = null;
      const pickedFile = getPickedFile(imageKind);

      if(pickedFile){
        const caption =
`üìå Taka Hisab
üóìÔ∏è ${data.date || ''} ‚è∞ ${data.time || ''}
üè∑Ô∏è ${data.cat || ''} | ${data.account || ''}
üí∞ Amount: ${data.amount ?? 0}
üìù ${data.details || ''}`.slice(0, 900);

        try{
          const resp = await postImageToTelegram(pickedFile, caption);
          imageMeta = {
            file_id: resp.file_id,
            message_id: resp.message_id || null,
            posted_at: Date.now()
          };
        }catch(e){
          // upload fail ‡¶π‡¶≤‡ßá‚Äîtransaction save ‡¶π‡¶¨‡ßá ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ image ‡¶õ‡¶æ‡ßú‡¶æ
          alert("‡¶õ‡¶¨‡¶ø Telegram ‡¶è ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶∏‡ßá‡¶≠ ‡¶π‡¶¨‡ßá (‡¶õ‡¶¨‡¶ø ‡¶õ‡¶æ‡ßú‡¶æ)‡•§");
          imageMeta = null;
        }
      } else {
        // ‚úÖ edit mode: ‡¶®‡¶§‡ßÅ‡¶® file ‡¶®‡¶æ ‡¶¶‡¶ø‡¶≤‡ßá existing image ‡¶•‡¶æ‡¶ï‡¶¨‡ßá (remove ‡¶ï‡¶∞‡¶≤‡ßá null)
        imageMeta = existingImageByKind[imageKind] || null;
      }

      const entry = { id: currentEditId || Date.now(), ...data, type };

      // ‚úÖ attach image meta (if any)
      if(imageMeta) entry.image = imageMeta;

      adjustBalances(entry, false);
      transactions.push(entry);
      sortTransactions();

      balances.total = computeTakaOnlyTotal();

      updateFirebase();

      /* ‚úÖ CHANGED: saving ‡¶ö‡¶≤‡¶≤‡ßá‡¶ì ‡¶´‡¶∞‡ßç‡¶Æ force ‡¶ï‡¶∞‡ßá ‡¶¨‡¶®‡ßç‡¶ß ‡¶π‡¶¨‡ßá */
      closeForm(true);
    }

    function displayTransactions() {
      const body = document.getElementById('transactionBody');
      if(!body) return;
      body.innerHTML = "";

      const start = (currentPage - 1) * currentRowsPerPage;
      const end = start + currentRowsPerPage;
      const paginated = transactions.slice(start, end);

      if(paginated.length === 0) {
        body.innerHTML = `
          <div class="transaction-item">
            <div class="col-serial">‚Äî</div>
            <div class="col-date">‚Äî</div>
            <div class="col-time">‚Äî</div>
            <div class="col-cat">‚Äî</div>
            <div class="col-ac">‚Äî</div>
            <div class="col-amt" style="color:rgba(15,23,42,.65)">‡¶ï‡ßã‡¶® ‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡ßá‡¶á</div>
            <div class="col-det">‚Äî</div>
            <div class="col-img">‚Äî</div>
            <div class="col-act">‚Äî</div>
          </div>`;
        return;
      }

      const totalLen = transactions.length;

      paginated.forEach((t, idx) => {
        const row = document.createElement('div');
        row.className = "transaction-item";

        const fullIndex = start + idx;
        const serial = totalLen - fullIndex;

        const hasImg = !!(t?.image?.file_id);

        row.innerHTML = `
          <div class="col-serial">${serial}</div>
          <div class="col-date">${t.date ?? ''}</div>
          <div class="col-time">${t.time ?? ''}</div>
          <div class="col-cat">${t.cat ?? ''}</div>
          <div class="col-ac">${t.account ?? ''}</div>
          <div class="col-amt" style="color: ${Number(t.amount) >= 0 ? '#16a34a' : '#ef4444'}; font-weight:900;">
            ${t.amount ?? 0}
          </div>
          <div class="col-det">${t.details || ''}</div>

          <div class="col-img">
            <button class="img-btn ${hasImg ? '' : 'noimg'}" title="${hasImg ? 'View Image' : 'No Image'}"
              onclick='${hasImg ? `window.openImageModal(${JSON.stringify(t).replace(/'/g,"\\'")})` : "return false;"}'>
              ${hasImg ? 'üíæ' : '‚ÅâÔ∏è'}
            </button>
          </div>

          <div class="col-act">
            <div class="action-buttons">
              <button class="edit-btn" onclick="window.editTransaction('${t.id}')">‚úèÔ∏è</button>
              <button class="delete-btn" onclick="window.deleteTransaction('${t.id}')">üóëÔ∏è</button>
            </div>
          </div>`;
        body.appendChild(row);
      });
    }

    function setupPagination() {
      const totalPages = Math.ceil(transactions.length / currentRowsPerPage);
      const container = document.querySelector('.pagination-controls');
      if (!container) return;
      container.innerHTML = '';
      if (totalPages <= 1) return;

      const maxPages = 5;
      let start = Math.max(1, currentPage - 2);
      let end = Math.min(totalPages, start + maxPages - 1);

      const prev = createPaginationButton('<<', currentPage - 1);
      if (currentPage === 1) prev.classList.add('disabled-nav');
      container.appendChild(prev);

      for (let i = start; i <= end; i++) {
        const btn = createPaginationButton(i, i);
        if (i === currentPage) btn.classList.add('active-page');
        container.appendChild(btn);
      }

      const next = createPaginationButton('>>', currentPage + 1);
      if (currentPage === totalPages) next.classList.add('disabled-nav');
      container.appendChild(next);
    }

    function createPaginationButton(text, page) {
      const link = document.createElement('a');
      link.innerText = text;
      link.href = '#';
      link.className = 'page-link';
      link.onclick = (e) => { e.preventDefault(); window.changePage(page); };
      return link;
    }

    document.addEventListener('DOMContentLoaded', () => {
      window.initializeData();
    });
  </script>
</body>
</html>
